# 虚假截图

## 优点

* 截图内容不会因网页尺寸而变形

* 可截出和实际内容不一致的图片内容

* 使用 `VUEX`，无需层层事件通知，逻辑更清晰

## 缺点

截图区域的 `HTML` 代码量翻倍

## 流程

点击生成按钮，改变 `VUEX` 状态，当前页面若干截图区域 `watch` 状态，触发响应函数

截图区域开始渲染，DOM生成后通知父组件，若有图表，在这时画

调用截图函数，返回 `Promise`，推入队列

队列全部完成后，返回相应数量的图片数据，调接口上传

## 相关文件

```js
'@/store/modules/app.js'
/*
  generateReportTime 累加
  reportImgList 局部变量 异步队列
  startGenerateReport() 改变状态 + 队列结束处理
  pushReportImg() 推入队列
*/
'@/components/pdf-wrapper'
/*
  通用组件 截图区域包裹
  v-if 控制区域DOM渲染
  监听 this.$store.getters.generateReportTime
  通知父组件 this.$emit('generateStart')
  调用截图方法并推入队列 this.$store.dispatch('app/pushReportImg', p)
  结束后销毁自身，同时通知父组件 this.$emit('generateEnd)
*/
'@/utils/export'
/*
  截图方法
  html2canvas 指定DOM渲染
  双重 import 调用时才加载资源
*/
```

## 内存泄漏

手动GC

* 图表销毁

* html

### 使用

1. 触发开始生成

```js
this.$store.dispatch('app/startGenerateReport')
```

2. 使用 `pdf-wrapper` 组件包裹

为了生成的图片与网页尺寸无关，需要将截图内容复制到组件插槽内，复制内容初始默认不渲染

若有图表，需要改变 `id`，如 `#chart` -> `#chart-pdf`，同时，修改画图函数，增加 `id` 参数

组件DOM首次渲染完成时，触发 `generateStart` 事件，在这里画复制内容里的图标

截图结束后，触发 `generateEnd` 事件，若有图表，在这里调用 `chart.destory()` 销毁，防止内存泄漏
